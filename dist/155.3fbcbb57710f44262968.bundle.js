"use strict";(self.webpackChunkceritaapp=self.webpackChunkceritaapp||[]).push([[155],{82:(t,e,a)=>{a.d(e,{kp:()=>c,gf:()=>i,Lx:()=>r,y_:()=>d,DY:()=>l,WG:()=>s,ht:()=>o});const n="https://story-api.dicoding.dev/v1";function i(){return localStorage.getItem("token")}function s(t){localStorage.setItem("token",t)}function o(t){localStorage.setItem("userName",t)}async function r(t,e){return await async function(t,e){const a=await fetch(`${n}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,password:e})});return await a.json()}(t,e)}async function l(t,e,a){return await async function(t,e,a){const i=await fetch(`${n}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t,email:e,password:a})});return await i.json()}(t,e,a)}async function c(t,e=1,a=10,i=0){return await async function(t,e=1,a=10,i=0){const s=new URL(`${n}/stories`);s.searchParams.set("page",e),s.searchParams.set("size",a),s.searchParams.set("location",i);const o=await fetch(s.toString(),{headers:{Authorization:`Bearer ${t}`}});return await o.json()}(t,e,a,i)}async function d(t,e,a,i,s){return await async function(t,e,a,i=null,s=null){const o=new FormData;o.append("description",e),o.append("photo",a),null!==i&&o.append("lat",i),null!==s&&o.append("lon",s);const r=await fetch(`${n}/stories`,{method:"POST",headers:{Authorization:`Bearer ${t}`},body:o});return await r.json()}(t,e,a,i,s)}},155:(t,e,a)=>{a.r(e),a.d(e,{default:()=>c});var n=a(481),i=a.n(n);const s=i().icon({iconUrl:"/assets/place_24dp_5985E1.png",iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]});class o{constructor(t){if(!t)throw new Error("Container element is required");this.container=t,this.takenPictures=[],this.selectedLocation={lat:null,lon:null},this._stream=null,this._map=null,this._marker=null,this.onSubmit=null,this.onCancel=null,this.onTakePhoto=null,this.onUploadPhoto=null}render(){this.container.innerHTML=`\n      <h2 style="text-align:center; margin-bottom:20px;">Tambah Cerita Baru</h2>\n      <form id="storyForm" class="story-form" novalidate>\n        <div class="form-control">\n          <label for="title">Judul Cerita:</label>\n          <input type="text" id="title" name="title" placeholder="Masukkan judul cerita" required />\n        </div>\n        <div class="form-control">\n          <label for="desc">Deskripsi Cerita:</label>\n          <textarea id="desc" name="desc" required placeholder="Tuliskan deskripsi cerita Anda..."></textarea>\n        </div>\n        <div class="form-control">\n          <label for="date">Tanggal Cerita:</label>\n          <input type="date" id="date" name="date" required value="${(new Date).toISOString().split("T")[0]}" />\n        </div>\n        <div class="form-control">\n          <label>Ambil Gambar dengan Kamera:</label>\n          <video id="camera" autoplay muted playsinline></video>\n          <canvas id="snapshot" style="display:none;"></canvas>\n          <button type="button" id="capture" class="btn btn-outline">Ambil Foto</button>\n          <ul id="taken-pictures-list" class="taken-pictures-list"></ul>\n        </div>\n        <div class="form-control">\n          <label>Atau Upload Gambar:</label>\n          <input type="file" id="fileUpload" accept="image/*" multiple />\n        </div>\n        <div class="form-control">\n          <label>Pilih Lokasi (klik pada peta):</label>\n          <div id="map" style="height:300px;"></div>\n          <div id="location-display">\n            Lokasi dipilih: <span id="location-lat">-</span>, <span id="location-lon">-</span>\n          </div>\n        </div>\n        <div class="form-buttons">\n          <button class="btn" type="submit">Kirim Cerita</button>\n          <button type="button" id="cancel-button" class="btn btn-outline">Batal</button>\n        </div>\n      </form>\n    `,this.#t(),this.#e(),this.#a()}#t(){const t=this.container.querySelector("#storyForm"),e=this.container.querySelector("#capture"),a=this.container.querySelector("#fileUpload"),n=this.container.querySelector("#cancel-button"),i=this.container.querySelector("#camera"),s=this.container.querySelector("#snapshot");t.addEventListener("submit",(e=>{if(e.preventDefault(),!t.checkValidity())return void t.reportValidity();if(0===this.takenPictures.length)return void alert("Anda harus menambahkan minimal satu gambar.");const a=this.takenPictures[0];if(a.size>1048576)alert("Ukuran gambar maksimal 1MB.");else if(this.onSubmit){const e=`${t.elements.title.value.trim()}\n\n${t.elements.desc.value.trim()}\n\nTanggal: ${t.elements.date.value}`;this.onSubmit(e,a,this.selectedLocation)}})),n.addEventListener("click",(()=>{this.onCancel&&this.onCancel()})),e.addEventListener("click",(()=>{if(!i.videoWidth||!i.videoHeight)return void alert("Video kamera belum siap.");const t=s.getContext("2d");s.width=i.videoWidth,s.height=i.videoHeight,t.drawImage(i,0,0,s.width,s.height),s.style.display="block",i.style.display="none",s.toBlob((t=>{t&&(this.addTakenPicture(t),this.onTakePhoto&&this.onTakePhoto(t))}),"image/jpeg")})),a.addEventListener("change",(t=>{Array.from(t.target.files).forEach((t=>{t.type.startsWith("image/")&&(this.addTakenPicture(t),this.onUploadPhoto&&this.onUploadPhoto(t))})),a.value=""}))}#e(){const t=this.container.querySelector("#camera");this.stopCamera(),navigator.mediaDevices.getUserMedia({video:!0}).then((e=>{this._stream=e,t.srcObject=e,t.style.display="block";const a=this.container.querySelector("#snapshot");a&&(a.style.display="none")})).catch((t=>{console.error("Tidak dapat mengakses kamera",t),alert("Akses kamera ditolak atau tidak tersedia.")}))}#a(){this._map=i().map("map").setView([-2.5,117.5],5),i().tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap contributors"}).addTo(this._map),this._marker=null,this._map.on("click",(t=>{const{lat:e,lng:a}=t.latlng;this._marker?this._marker.setLatLng(t.latlng):this._marker=i().marker(t.latlng,{icon:s}).addTo(this._map),this.updateLocation(e,a)}))}addTakenPicture(t){this.takenPictures.push(t),this.#n()}#n(){const t=this.container.querySelector("#taken-pictures-list");t.innerHTML="",this.takenPictures.forEach(((e,a)=>{const n=document.createElement("li");n.className="taken-pictures-list__item";const i=document.createElement("img");i.src=URL.createObjectURL(e),i.alt=`Foto dokumentasi ${a+1}`,i.width=100;const s=document.createElement("button");s.type="button",s.className="delete-picture-btn",s.title="Hapus foto ini",s.textContent="×",s.addEventListener("click",(()=>{this.takenPictures.splice(a,1),this.#n()})),n.appendChild(i),n.appendChild(s),t.appendChild(n)}))}updateLocation(t,e){this.selectedLocation={lat:t,lon:e},this.container.querySelector("#location-lat").textContent=t?.toFixed(6)||"-",this.container.querySelector("#location-lon").textContent=e?.toFixed(6)||"-"}stopCamera(){try{if(this._stream&&(this._stream.getTracks().forEach((t=>t.stop())),this._stream=null),this.container){const t=this.container.querySelector("#camera");t&&(t.pause(),t.srcObject=null,t.style.display="none");const e=this.container.querySelector("#snapshot");e&&(e.style.display="none")}}catch(t){console.warn("stopCamera error:",t)}}}var r=a(82),l=a(885);class c{#i;constructor(t){if(!t)throw new Error("Container element is required");this.#i=new o(t),this.#i.onSubmit=this.handleSubmit.bind(this),this.#i.onCancel=this.handleCancel.bind(this)}async init(){this.#i.render()}stopCamera(){this.#i&&"function"==typeof this.#i.stopCamera&&this.#i.stopCamera()}async handleSubmit(t,e,a){const n=r.gf();if(n)try{const i=await r.y_(n,t,e,a.lat,a.lon);i.error?alert("Gagal menambahkan cerita: "+i.message):(alert("Cerita berhasil ditambahkan"),await(0,l.V)("#stories"))}catch(t){alert("Terjadi kesalahan jaringan."),console.error(t)}else alert("Anda harus login terlebih dahulu.")}async handleCancel(){await(0,l.V)("#stories")}}}}]);
//# sourceMappingURL=155.3fbcbb57710f44262968.bundle.js.map